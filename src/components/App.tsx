import { useEffect, useState } from "react";
import { Navigate, Route, Routes, HashRouter } from "react-router-dom";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { useSelector, useDispatch } from "react-redux";
import { RootState } from "@/slices";
import { initAuth } from "@/slices/thunks/authThunks";
import { setToken } from "@/slices/authSlice";
import { init } from "@/init";
import { getInitDataRaw } from "@/utils/initData";
import { routes } from "@/navigation/routes";
import { ModalRemove } from "@/components/modals/ModalRemove";
import { ModalRename } from "@/components/modals/ModalRename";
import { getToken } from "@/utils/tokenStorage";
import { logger } from "@/utils/logger";

const queryClient = new QueryClient();

export function App() {
  const dispatch = useDispatch();
  const { token } = useSelector((state: RootState) => state.auth);
  const [isInitialized, setIsInitialized] = useState(false);
  const [isCheckingAuth, setIsCheckingAuth] = useState(true);

  useEffect(() => {
    const initializeApp = async () => {
      logger.log('[App] üöÄ –ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
      try {
        await init({
          debug: true,
          eruda: true,
          mockForMacOS: true,
        });
        logger.log('[App] ‚úÖ SDK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
        setIsInitialized(true);
      } catch (err: any) {
        logger.error('[App] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ SDK:', err);
        setIsInitialized(true);
      }
    };
    initializeApp();
  }, [dispatch]);

  useEffect(() => {
    if (!isInitialized) {
      logger.log('[App] ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ SDK...');
      return;
    }

    const checkAuthAndInit = async () => {
      logger.log('[App] üîê –ù–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
      
      try {
        const storedToken = await getToken();
        logger.log('[App] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞:', {
          hasToken: !!storedToken,
          tokenLength: storedToken?.length || 0,
          tokenPreview: storedToken ? storedToken.substring(0, 20) + '...' : 'N/A'
        });
        
        if (storedToken) {
          logger.log('[App] ‚úÖ –ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ');
          logger.log('[App] üéâ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω)');
          dispatch(setToken(storedToken));
          setIsCheckingAuth(false);
          return;
        }
        
        logger.log('[App] –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ª—É—á–∞–µ–º init data...');
        const initDataRaw = getInitDataRaw();
        
        logger.log('[App] –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω–∏—è init data:', {
          hasInitData: !!initDataRaw,
          initDataLength: initDataRaw?.length || 0
        });
        
        if (initDataRaw) {
          logger.log('[App] ‚úÖ Init data –ø–æ–ª—É—á–µ–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...');
          dispatch(initAuth(initDataRaw) as any);
          logger.log('[App] üéâ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (—á–µ—Ä–µ–∑ init data)');
        } else {
          logger.warn('[App] ‚ö†Ô∏è Init data –Ω–µ –ø–æ–ª—É—á–µ–Ω, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞');
        }
        setIsCheckingAuth(false);
      } catch (err: any) {
        logger.error('[App] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', err);
        logger.error('[App] Stack trace:', err.stack);
        setIsCheckingAuth(false);
      }
    };

    logger.log('[App] üîÑ –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
    checkAuthAndInit();
  }, [isInitialized, dispatch]);

  if (isCheckingAuth) {
    return null;
  }
  
  if (!token) {
    return null;
  }

  return (
    <QueryClientProvider client={queryClient}>
      <HashRouter>
        <Routes>
          {routes.map((route) => (
            <Route key={route.path} {...route} />
          ))}
          <Route path="*" element={<Navigate to="/" />} />
        </Routes>
      </HashRouter>

      {/* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –º–æ–¥–∞–ª–∫–∏ */}
      <ModalRemove />
      <ModalRename />
    </QueryClientProvider>
  );
}